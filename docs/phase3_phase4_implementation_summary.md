# Phase 3 & Phase 4 êµ¬í˜„ ì™„ë£Œ - PPT RAG ì„±ëŠ¥ í–¥ìƒ

**êµ¬í˜„ ì¼ì**: 2025-11-05
**ë²„ì „**: v3.2.0 (ì˜ˆì •)
**ì´ì „ ë²„ì „**: v3.1.0 (Phase 1 & 2)

---

## ëª©ì°¨
1. [Phase 3: ìŠ¬ë¼ì´ë“œ íƒ€ì… ë¶„ë¥˜](#phase-3-ìŠ¬ë¼ì´ë“œ-íƒ€ì…-ë¶„ë¥˜)
2. [Phase 4: í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ (BM25 + Vector)](#phase-4-í•˜ì´ë¸Œë¦¬ë“œ-ê²€ìƒ‰-bm25--vector)
3. [êµ¬í˜„ íŒŒì¼ ëª©ë¡](#êµ¬í˜„-íŒŒì¼-ëª©ë¡)
4. [í…ŒìŠ¤íŠ¸ ë°©ë²•](#í…ŒìŠ¤íŠ¸-ë°©ë²•)
5. [ì˜ˆìƒ ì„±ëŠ¥ í–¥ìƒ](#ì˜ˆìƒ-ì„±ëŠ¥-í–¥ìƒ)
6. [ë‹¤ìŒ ë‹¨ê³„](#ë‹¤ìŒ-ë‹¨ê³„)

---

## Phase 3: ìŠ¬ë¼ì´ë“œ íƒ€ì… ë¶„ë¥˜

### ê°œìš”
ìŠ¬ë¼ì´ë“œë¥¼ 9ê°€ì§€ íƒ€ì…ìœ¼ë¡œ ìë™ ë¶„ë¥˜í•˜ê³ , íƒ€ì…ë³„ë¡œ ê²€ìƒ‰ ê°€ì¤‘ì¹˜ë¥¼ ì°¨ë“± ì ìš©í•©ë‹ˆë‹¤.

### ìŠ¬ë¼ì´ë“œ íƒ€ì… (9ì¢…ë¥˜)
| íƒ€ì… | ì„¤ëª… | ê°€ì¤‘ì¹˜ | ìš°ì„ ìˆœìœ„ |
|------|------|--------|----------|
| **table_heavy** | í‘œ 2ê°œ ì´ìƒ | 1.3 | ìµœê³  |
| **table_focused** | í‘œ 1ê°œ + ì ì€ í…ìŠ¤íŠ¸ | 1.3 | ìµœê³  |
| **chart_heavy** | ì°¨íŠ¸ 2ê°œ ì´ìƒ | 1.2 | ë†’ìŒ |
| **chart_focused** | ì°¨íŠ¸ 1ê°œ + ì ì€ í…ìŠ¤íŠ¸ | 1.2 | ë†’ìŒ |
| **bullet_list** | ë¶ˆë¦¿ í¬ì¸íŠ¸ 5ê°œ ì´ìƒ | 1.0 | ê¸°ë³¸ |
| **text_heavy** | ê¸´ í…ìŠ¤íŠ¸ (500ì ì´ìƒ) | 0.9 | ë‚®ìŒ |
| **image_heavy** | ì´ë¯¸ì§€ 2ê°œ ì´ìƒ | 1.1 | ë³´í†µ |
| **minimal** | ìµœì†Œ í…ìŠ¤íŠ¸ (100ì ë¯¸ë§Œ) | 0.7 | ìµœì € |
| **mixed** | í˜¼í•©í˜• | 1.0 | ê¸°ë³¸ |

### ë¶„ë¥˜ ë¡œì§
```python
def _classify_slide_type(self, slide) -> str:
    # ìŠ¬ë¼ì´ë“œ ìš”ì†Œ ë¶„ì„
    - table_count: í‘œ ê°œìˆ˜
    - chart_count: ì°¨íŠ¸ ê°œìˆ˜
    - image_count: ì´ë¯¸ì§€ ê°œìˆ˜
    - bullet_count: ë¶ˆë¦¿ í¬ì¸íŠ¸ ê°œìˆ˜
    - total_text_length: í…ìŠ¤íŠ¸ ê¸¸ì´

    # ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ë¶„ë¥˜
    if table_count >= 2: return "table_heavy"
    elif table_count == 1 and text < 200: return "table_focused"
    elif chart_count >= 2: return "chart_heavy"
    elif chart_count == 1 and text < 200: return "chart_focused"
    ...
```

### êµ¬í˜„ ìœ„ì¹˜
- **íŒŒì¼**: `utils/pptx_chunking_engine.py`
- **ë©”ì„œë“œ**:
  - `_classify_slide_type(slide)`: ìŠ¬ë¼ì´ë“œ íƒ€ì… ë¶„ë¥˜ (lines 909-984)
  - `_get_chunk_weight_by_slide_type(slide_type)`: ê°€ì¤‘ì¹˜ ë°˜í™˜ (lines 986-1000)
  - `_get_optimal_chunk_size_by_type(slide_type)`: ìµœì  ì²­í¬ í¬ê¸° (Phase 6 ì¤€ë¹„, lines 1002-1016)

### ì ìš© ë°©ì‹
- **ì²­í‚¹ ì‹œ**: ëª¨ë“  ìŠ¬ë¼ì´ë“œë¥¼ ë¶„ë¥˜í•˜ê³  íƒ€ì…ë³„ ê°€ì¤‘ì¹˜ë¥¼ ë©”íƒ€ë°ì´í„°ì— ì €ì¥
- **ê²€ìƒ‰ ì‹œ**: ì²­í¬ì˜ ê°€ì¤‘ì¹˜ë¥¼ ê²€ìƒ‰ ì ìˆ˜ì— ê³±í•˜ì—¬ ìš°ì„ ìˆœìœ„ ì¡°ì •
- **ì˜ˆì‹œ**:
  ```
  ìŠ¬ë¼ì´ë“œ 5 ì²˜ë¦¬ ì¤‘...
    ìŠ¬ë¼ì´ë“œ íƒ€ì…: table_heavy (ê°€ì¤‘ì¹˜: 1.3)
  ```

### ë©”íƒ€ë°ì´í„° ì¶”ê°€
```python
# utils/pptx_chunking.pyì— slide_type í•„ë“œ ì¶”ê°€
@dataclass
class PPTXChunkMetadata:
    ...
    slide_type: Optional[str] = None  # "table_heavy", "chart_heavy", etc.
```

### ì˜ˆìƒ íš¨ê³¼
- **í‘œ/ì°¨íŠ¸ ì¤‘ì‹¬ ìŠ¬ë¼ì´ë“œ ìš°ì„ ìˆœìœ„ í–¥ìƒ**: +15-20%
- **ë¶ˆí•„ìš”í•œ ìŠ¬ë¼ì´ë“œ (minimal) ì œì™¸**: ë…¸ì´ì¦ˆ ê°ì†Œ
- **ê²€ìƒ‰ ì •í™•ë„ ì „ë°˜ì  í–¥ìƒ**: +15-20%

---

## Phase 4: í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ (BM25 + Vector)

### ê°œìš”
BM25 (í‚¤ì›Œë“œ ê¸°ë°˜) + Vector (ì˜ë¯¸ ê¸°ë°˜) í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ìœ¼ë¡œ ê²€ìƒ‰ ì •í™•ë„ë¥¼ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.

### í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ì›ë¦¬

#### 1. BM25 (Best Matching 25)
- **ë°©ì‹**: Sparse retrieval, í‚¤ì›Œë“œ ë¹ˆë„ ê¸°ë°˜
- **ì¥ì **:
  - ì •í™•í•œ ìš©ì–´ ë§¤ì¹­ (ì˜ˆ: "TADF", "Q2")
  - ì•½ì–´, ê³ ìœ ëª…ì‚¬, ìˆ«ìì— ê°•í•¨
  - ê³„ì‚° ì†ë„ ë¹ ë¦„
- **ë‹¨ì **:
  - ë™ì˜ì–´ ì¸ì‹ ë¶ˆê°€
  - ë¬¸ë§¥ ì´í•´ ë¶€ì¡±

#### 2. Vector Search (Semantic)
- **ë°©ì‹**: Dense retrieval, ì„ë² ë”© ìœ ì‚¬ë„ ê¸°ë°˜
- **ì¥ì **:
  - ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ (ë™ì˜ì–´ ì¸ì‹)
  - ë¬¸ë§¥ ì´í•´ ê°€ëŠ¥
- **ë‹¨ì **:
  - ì •í™•í•œ ìš©ì–´ ë§¤ì¹­ ì•½í•¨
  - ê³„ì‚° ë¹„ìš© ë†’ìŒ

#### 3. Reciprocal Rank Fusion (RRF)
```python
# ìœµí•© ê³µì‹
score(document) = Î£ 1 / (k + rank(document))
k = 60  # RRF ìƒìˆ˜

# ìµœì¢… ì ìˆ˜
final_score = (BM25_weight * BM25_rrf) + (Vector_weight * Vector_rrf)
```

### êµ¬í˜„ ìœ„ì¹˜
- **ìƒˆ íŒŒì¼**: `utils/hybrid_retriever.py`
- **í´ë˜ìŠ¤**: `HybridRetriever`
- **í†µí•© ìœ„ì¹˜**: `utils/rag_chain.py`

### ì£¼ìš” ë©”ì„œë“œ
```python
class HybridRetriever:
    def __init__(self, vector_manager, bm25_weight=0.5):
        # BM25:Vector = 0.5:0.5 (ê¸°ë³¸ê°’)

    def build_bm25_index(self):
        # Chromaì˜ ëª¨ë“  ë¬¸ì„œë¥¼ BM25 ì¸ë±ìŠ¤ë¡œ êµ¬ì¶•

    def search(self, query: str, top_k: int = 20):
        # 1. BM25 ê²€ìƒ‰
        # 2. Vector ê²€ìƒ‰
        # 3. RRF ìœµí•©
        # 4. ìƒìœ„ kê°œ ë°˜í™˜

    def _tokenize(self, text: str):
        # í•œê¸€/ì˜ë¬¸ í† í°í™” (ê°„ë‹¨í•œ í˜•íƒœì†Œ ë¶„ë¦¬)
```

### RAGChain í†µí•©
```python
# utils/rag_chain.pyì˜ __init__()ì—ì„œ ì´ˆê¸°í™”
self.hybrid_retriever = HybridRetriever(
    vector_manager=vectorstore,
    bm25_weight=0.5  # BM25:Vector = 0.5:0.5
)
self.hybrid_retriever.build_bm25_index()

# _search_candidates() ë©”ì„œë“œì—ì„œ ì‚¬ìš©
if self.enable_hybrid_search and self.hybrid_retriever:
    hybrid_results = self.hybrid_retriever.search(question, top_k=initial_k)
```

### ì„¤ì • íŒŒë¼ë¯¸í„°
- **enable_hybrid_search**: `True` (ê¸°ë³¸ í™œì„±í™”)
- **hybrid_bm25_weight**: `0.5` (BM25:Vector = 0.5:0.5)

### ê°€ì¤‘ì¹˜ ì¡°ì • ê°€ì´ë“œ
| BM25 Weight | Vector Weight | íŠ¹ì§• | ì í•©í•œ ê²½ìš° |
|-------------|---------------|------|-------------|
| 0.7 | 0.3 | BM25 ìš°ì„  | ì •í™•í•œ í‚¤ì›Œë“œ ê²€ìƒ‰ ì¤‘ìš” |
| 0.5 | 0.5 | ê· í˜• (ê¸°ë³¸) | ì¼ë°˜ì ì¸ ê²½ìš° |
| 0.3 | 0.7 | Vector ìš°ì„  | ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ ì¤‘ìš” |

### ì˜ˆìƒ íš¨ê³¼
- **í‚¤ì›Œë“œ ë§¤ì¹­ ì •í™•ë„**: +30-40%
- **ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ ìœ ì§€**: ê¸°ì¡´ ìˆ˜ì¤€
- **ì „ë°˜ì  ê²€ìƒ‰ ì •í™•ë„**: +30-40%
- **íŠ¹íˆ íš¨ê³¼ì ì¸ ê²½ìš°**:
  - ì•½ì–´, ê³ ìœ ëª…ì‚¬ ê²€ìƒ‰ (TADF, ACRSA)
  - ìˆ«ì ê²€ìƒ‰ (Q2, 145ì–µ)
  - ì •í™•í•œ ìš©ì–´ ê²€ìƒ‰

---

## êµ¬í˜„ íŒŒì¼ ëª©ë¡

### ìˆ˜ì •ëœ íŒŒì¼
1. **utils/pptx_chunking.py** (+2 lines)
   - `PPTXChunkMetadata`ì— `slide_type` í•„ë“œ ì¶”ê°€

2. **utils/pptx_chunking_engine.py** (+150 lines)
   - Phase 3 ë©”ì„œë“œ 3ê°œ ì¶”ê°€
   - `process_pptx_document()` ë©”ì„œë“œì— íƒ€ì… ë¶„ë¥˜ í†µí•©
   - ëª¨ë“  ì²­í¬ì— `slide_type` ë° ê°€ì¤‘ì¹˜ ì ìš©

3. **utils/rag_chain.py** (+80 lines)
   - HybridRetriever import
   - `__init__()` íŒŒë¼ë¯¸í„° ì¶”ê°€ ë° ì´ˆê¸°í™”
   - `_search_candidates()` ë©”ì„œë“œ ìˆ˜ì •

4. **desktop_app.py** (+3 lines)
   - RAGChain ì´ˆê¸°í™” ì‹œ hybrid search íŒŒë¼ë¯¸í„° ì¶”ê°€

### ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼
5. **utils/hybrid_retriever.py** (274 lines, ìƒˆ íŒŒì¼)
   - HybridRetriever í´ë˜ìŠ¤ êµ¬í˜„
   - BM25 + Vector ìœµí•© ë¡œì§

### ë¬¸ì„œ íŒŒì¼
6. **docs/phase3_phase4_implementation_summary.md** (ì´ íŒŒì¼)

---

## í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ìˆ˜ë™ í…ŒìŠ¤íŠ¸ (ê¶Œì¥)

#### Phase 3 í…ŒìŠ¤íŠ¸: ìŠ¬ë¼ì´ë“œ íƒ€ì… ë¶„ë¥˜ í™•ì¸
1. PPT íŒŒì¼ ì—…ë¡œë“œ
2. ì½˜ì†” ì¶œë ¥ í™•ì¸:
   ```
   ìŠ¬ë¼ì´ë“œ 1 ì²˜ë¦¬ ì¤‘...
     ìŠ¬ë¼ì´ë“œ íƒ€ì…: table_heavy (ê°€ì¤‘ì¹˜: 1.3)
   ìŠ¬ë¼ì´ë“œ 2 ì²˜ë¦¬ ì¤‘...
     ìŠ¬ë¼ì´ë“œ íƒ€ì…: bullet_list (ê°€ì¤‘ì¹˜: 1.0)
   ```
3. ê²€ìƒ‰ ì‹œ í‘œ/ì°¨íŠ¸ ìŠ¬ë¼ì´ë“œê°€ ìš°ì„  ê²€ìƒ‰ë˜ëŠ”ì§€ í™•ì¸

#### Phase 4 í…ŒìŠ¤íŠ¸: Hybrid Search í™•ì¸
1. ë¬¸ì„œ ì—…ë¡œë“œ (BM25 ì¸ë±ìŠ¤ ìë™ êµ¬ì¶•)
2. ê²€ìƒ‰ ìˆ˜í–‰
3. ì½˜ì†” ì¶œë ¥ í™•ì¸:
   ```
   [HybridRetriever] BM25 ì¸ë±ìŠ¤ êµ¬ì¶• ì™„ë£Œ: 127ê°œ ë¬¸ì„œ
   ğŸ” [Phase 4] Hybrid Search (BM25+Vector) ì‚¬ìš© (top_k=60)
   [HybridRetriever] BM25 ê²€ìƒ‰: 43ê°œ ê²°ê³¼
   [HybridRetriever] Vector ê²€ìƒ‰: 60ê°œ ê²°ê³¼
   [HybridRetriever] ìœµí•© ì™„ë£Œ: 60ê°œ ê²°ê³¼ (BM25:43, Vector:60)
   ```

#### ê²€ìƒ‰ ì •í™•ë„ í…ŒìŠ¤íŠ¸
**í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬**:
- "TADF ì¬ë£ŒëŠ”?" (ì •í™•í•œ ìš©ì–´ - BM25 ê°•ì )
- "Q2 ë§¤ì¶œì€?" (ìˆ«ì ê²€ìƒ‰ - BM25 ê°•ì )
- "ë¶„ê¸°ë³„ ì„±ê³¼" (ì˜ë¯¸ ê¸°ë°˜ - Vector ê°•ì )
- "2ë¶„ê¸° ì‹¤ì  ë¶„ì„" (í•˜ì´ë¸Œë¦¬ë“œ ê°•ì )

### 2. ìë™ í…ŒìŠ¤íŠ¸ (í–¥í›„)
```python
# í–¥í›„ êµ¬í˜„ ì˜ˆì •
python test_phase3_phase4.py
```

---

## ì˜ˆìƒ ì„±ëŠ¥ í–¥ìƒ

### ê°œë³„ Phase íš¨ê³¼
| Phase | ê¸°ëŠ¥ | ì˜ˆìƒ í–¥ìƒ |
|-------|------|----------|
| **Phase 1** | í‘œ êµ¬ì¡° ë³´ì¡´ (v3.1.0) | +20-30% |
| **Phase 2** | ìŠ¬ë¼ì´ë“œ ë¬¸ë§¥ (v3.1.0) | +10-15% |
| **Phase 3** | ìŠ¬ë¼ì´ë“œ íƒ€ì… ë¶„ë¥˜ | +15-20% |
| **Phase 4** | Hybrid Search (BM25+Vector) | +30-40% |

### ëˆ„ì  íš¨ê³¼
- **Phase 1-2 (v3.1.0)**: ë² ì´ìŠ¤ë¼ì¸ ëŒ€ë¹„ +30-45%
- **Phase 1-4 (v3.2.0)**: **ë² ì´ìŠ¤ë¼ì¸ ëŒ€ë¹„ +70-100%** (ì˜ˆìƒ)
- **ì‹œë„ˆì§€ íš¨ê³¼**: ê° Phaseê°€ ìƒí˜¸ ë³´ì™„ì ìœ¼ë¡œ ì‘ë™

### íŠ¹íˆ ê°œì„ ë  ì˜ì—­
1. **í‘œ/ì°¨íŠ¸ ê²€ìƒ‰**: Phase 1 + Phase 3 ì‹œë„ˆì§€ â†’ +50-70%
2. **í‚¤ì›Œë“œ ì •í™•ë„**: Phase 4 BM25 â†’ +30-40%
3. **ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰**: Phase 2 + Phase 4 Vector â†’ ìœ ì§€ + í–¥ìƒ
4. **ìŠ¬ë¼ì´ë“œ ìš°ì„ ìˆœìœ„**: Phase 3 â†’ +15-20%

---

## ë‹¤ìŒ ë‹¨ê³„

### Phase 5: ìŠ¬ë¼ì´ë“œ ê´€ê³„ ê·¸ë˜í”„ (ì„ íƒ)
- **ìš°ì„ ìˆœìœ„**: â˜…â˜…â˜…â˜…â˜†
- **ì˜ˆìƒ íš¨ê³¼**: +10-15%
- **ë‚´ìš©**: ìŠ¬ë¼ì´ë“œ ê°„ ì°¸ì¡° ê´€ê³„ ê·¸ë˜í”„ êµ¬ì¶•

### Phase 6: ë™ì  ì²­í¬ í¬ê¸° ì¡°ì • (ì„ íƒ)
- **ìš°ì„ ìˆœìœ„**: â˜…â˜…â˜†â˜†â˜†
- **ì˜ˆìƒ íš¨ê³¼**: +5-10%
- **ë‚´ìš©**: ìŠ¬ë¼ì´ë“œ íƒ€ì…ë³„ ìµœì  ì²­í¬ í¬ê¸° ì¡°ì • (Phase 3 ê¸°ë°˜)

### Smart Vision ì ìš© (ì„ íƒ)
- **ìš°ì„ ìˆœìœ„**: â˜…â˜…â˜…â˜†â˜†
- **ë¹„ìš© ì ˆê°**: 70% (Phase 3 ê¸°ë°˜ ì„ íƒì  ì ìš©)
- **ë‚´ìš©**: table_heavy/chart_heavy ìŠ¬ë¼ì´ë“œë§Œ Vision ì ìš©

### ì„±ëŠ¥ ê²€ì¦
- **í…ŒìŠ¤íŠ¸ ë°ì´í„°ì…‹**: ê¸°ì¡´ PPT íŒŒì¼ (3-5ê°œ)
- **ì¸¡ì • ì§€í‘œ**:
  - ê²€ìƒ‰ ì •í™•ë„ (Hit Rate)
  - ê²€ìƒ‰ ì†ë„
  - ì²­í¬ ê°€ì¤‘ì¹˜ ë¶„í¬
  - BM25 vs Vector ê¸°ì—¬ë„

---

## êµ¬í˜„ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] Phase 3: ìŠ¬ë¼ì´ë“œ íƒ€ì… ë¶„ë¥˜ (9ì¢…ë¥˜)
- [x] Phase 3: íƒ€ì…ë³„ ê°€ì¤‘ì¹˜ ì ìš©
- [x] Phase 3: ë©”íƒ€ë°ì´í„° í™•ì¥ (slide_type)
- [x] Phase 4: HybridRetriever í´ë˜ìŠ¤ êµ¬í˜„
- [x] Phase 4: BM25 ì¸ë±ìŠ¤ êµ¬ì¶•
- [x] Phase 4: RRF ìœµí•© ë¡œì§
- [x] Phase 4: RAGChain í†µí•©
- [x] desktop_app.py íŒŒë¼ë¯¸í„° ì¶”ê°€
- [x] ë¬¸ì„œí™”

---

## ì°¸ê³  ë¬¸ì„œ

- [Phase 1 & 2 êµ¬í˜„ ìš”ì•½](phase1_phase2_implementation_summary.md)
- [PPT RAG ìµœì í™” ë°©ë²•ë¡ ](ppt_rag_optimization_methods.md)
- [ë¹„ì „ vs ì•Œê³ ë¦¬ì¦˜ ë¶„ì„](vision_vs_algorithm_analysis.md)
- [v3.1.0 ë²„ì „ ìš”ì•½](version_v3.1.0_summary.md)

---

**êµ¬í˜„ì**: Claude (Anthropic Claude Sonnet 4.5)
**ë‚ ì§œ**: 2025-11-05
**ë‹¤ìŒ ëª©í‘œ**: ì„±ëŠ¥ ê²€ì¦ ë° v3.2.0 ë¦´ë¦¬ìŠ¤
