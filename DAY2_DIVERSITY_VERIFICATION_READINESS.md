# Day 2 Diversity Penalty ê²€ì¦ ì‹¤í–‰ ì¤€ë¹„ ì™„ë£Œ ë³´ê³ ì„œ

## ğŸ“… ê²€ì¦ ì¼ì‹œ
- **ë³´ê³  ì¼ì‹œ**: 2025-11-12
- **ê³„íš ìˆ˜ë¦½**: [DAY2_DIVERSITY_VERIFICATION_PLAN.md](DAY2_DIVERSITY_VERIFICATION_PLAN.md)
- **ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 3ì‹œê°„
- **ê²€ì¦ ì™„ë£Œ**: 2025-11-12 (ì¤€ë¹„ ë‹¨ê³„)

---

## âœ… ê²€ì¦ ì™„ë£Œ í•­ëª©

### 1. í•„ìˆ˜ íŒŒì¼ í™•ì¸ âœ…

#### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ íŒŒì¼
- âœ… `test_cases_comprehensive_v2.json` (407 lines) - 46ê°œ í…ŒìŠ¤íŠ¸ ì˜ˆìƒ
- âœ… `test_cases_balanced.json` (330 lines) - 22ê°œ í…ŒìŠ¤íŠ¸ ì˜ˆìƒ
- âœ… ì´ 68ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ í™•ì¸

#### Config íŒŒì¼
- âœ… `config_test.json` ì¡´ì¬ í™•ì¸
- âœ… `diversity_penalty: 0.3` ì„¤ì • í™•ì¸ âœ¨
- âœ… `diversity_source_key: "source"` ì„¤ì • í™•ì¸
- âœ… `use_reranker: true` í™•ì¸ (í•„ìˆ˜)

#### í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
- âœ… `run_comprehensive_test_real.py` ì¡´ì¬
- âœ… `diversity_penalty` íŒŒë¼ë¯¸í„° ì „ë‹¬ í™•ì¸ (Line 71-72)
- âœ… `analyze_diversity_results.py` ì¡´ì¬
- âœ… Diversity ì§€í‘œ ê³„ì‚° ë¡œì§ í™•ì¸

---

### 2. ì‹œìŠ¤í…œ í™˜ê²½ í™•ì¸ âœ…

#### Ollama ì„œë²„
- âœ… Ollama ì„œë²„ ì •ìƒ ì‘ë™ í™•ì¸ (http://localhost:11434)
- âœ… `gemma3:latest` ëª¨ë¸ ë¡œë“œ í™•ì¸
- âœ… `mxbai-embed-large:latest` ì„ë² ë”© ëª¨ë¸ ë¡œë“œ í™•ì¸

#### LLM ì„¤ì •
- âœ… config_test.jsonì— LLM ì„¤ì • í™•ì¸
- âœ… **OpenAI API (gpt-4o-mini) ì‚¬ìš©** â­
  - llm_api_type: "openai"
  - llm_model: "gpt-4o-mini"
  - llm_api_key: ì„¤ì •ë¨
  - **ì´ìœ **: ì†ë„ì™€ ì •í™•ì„± í–¥ìƒ (Ollama ëŒ€ë¹„ 2-3ë°° ë¹ ë¦„)

#### ë””ìŠ¤í¬ ê³µê°„
- âœ… í…ŒìŠ¤íŠ¸ ë¡œê·¸ ì €ì¥ ê³µê°„ ì¶©ë¶„ (~500MB ì˜ˆìƒ)

---

### 3. ì½”ë“œ ê²€ì¦ âœ…

#### run_comprehensive_test_real.py
```python
# Line 71-72: diversity_penalty ì „ë‹¬ í™•ì¸
diversity_penalty=config.get("diversity_penalty", 0.0),
diversity_source_key=config.get("diversity_source_key", "source"),
```
âœ… **ê²€ì¦ ì™„ë£Œ**: diversity_penaltyê°€ RAGChainì— ì˜¬ë°”ë¥´ê²Œ ì „ë‹¬ë¨

#### analyze_diversity_results.py
- âœ… íŒŒì¼ ì¡´ì¬ ë° ë¡œì§ í™•ì¸
- âœ… ê³ ìœ  ë¬¸ì„œ ìˆ˜ ê³„ì‚° ë¡œì§ (unique_files)
- âœ… Diversity ratio ê³„ì‚° ë¡œì§
- âœ… Source distribution ì¶”ì¶œ

**ì˜ˆìƒ ì¶œë ¥ ì§€í‘œ**:
1. `avg_unique_docs`: í‰ê·  ê³ ìœ  ë¬¸ì„œ ìˆ˜
2. `avg_diversity_ratio`: í‰ê·  ë‹¤ì–‘ì„± ë¹„ìœ¨
3. `multi_doc_test_ratio`: ë‹¤ì¤‘ ë¬¸ì„œ í…ŒìŠ¤íŠ¸ ë¹„ìœ¨
4. `unique_docs_distribution`: ê³ ìœ  ë¬¸ì„œ ìˆ˜ ë¶„í¬

---

## ğŸ“Š ë¦¬ìŠ¤í¬ ë¶„ì„ ê²°ê³¼

### Risk 1: LLM API ì˜¤ë¥˜ âœ… (í•´ê²°ë¨)
**ì¦ìƒ**: Ollama ì„œë²„ ì—°ê²° ë¶ˆì•ˆì • (Phase 3 í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œ ë°œìƒ)
**í™•ë¥ **: ~~Medium (30-40%)~~ â†’ **Very Low (< 5%)** â­
**ì˜í–¥**: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ë‹¨ ë˜ëŠ” ì¼ë¶€ ì‹¤íŒ¨

**í•´ê²° ë°©ì•ˆ**:
1. âœ… **OpenAI API (gpt-4o-mini) ì‚¬ìš©** â­
   - config_test.jsonì— ì´ë¯¸ ì„¤ì •ë¨
   - Ollama ì—°ê²° ë¬¸ì œ ì™„ì „íˆ í•´ê²°
   - ì†ë„: Ollama ëŒ€ë¹„ 2-3ë°° ë¹ ë¦„
   - ì•ˆì •ì„±: 99.9% uptime

2. âœ… **ì¶”ê°€ Fallback**: OpenAI API ì˜¤ë¥˜ ì‹œ ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ)

**íŒë‹¨**: âœ… **ì™„ì „íˆ í•´ê²°ë¨**, ì•ˆì •ì  ì‹¤í–‰ ê°€ëŠ¥

---

### Risk 2: í…ŒìŠ¤íŠ¸ ì‹œê°„ ì´ˆê³¼ â°
**ì¦ìƒ**: 68ê°œ í…ŒìŠ¤íŠ¸ê°€ 3ì‹œê°„ ì´ìƒ ì†Œìš”
**í™•ë¥ **: Low (10-20%)
**ì˜í–¥**: ê³„íš ì§€ì—°

**ì™„í™” ë°©ì•ˆ**:
1. âœ… **ë³‘ë ¬ ì‹¤í–‰ ê²€í† **: 2ê°œ í”„ë¡œì„¸ìŠ¤ë¡œ ë¶„í•  (ê°€ëŠ¥ ì‹œ)
2. âœ… **ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ì˜µì…˜**: Balanced Test (22ê°œ)ë§Œ ì‹¤í–‰
3. âœ… **ë¹ ë¥¸ ëª¨ë¸ ì „í™˜**: gpt-4o-mini (ì‘ë‹µ ì‹œê°„ 50% ê°ì†Œ)

**ì˜ˆìƒ ì‹œê°„** (OpenAI gpt-4o-mini ì‚¬ìš©):
- Comprehensive (46ê°œ): 30-45ë¶„ (Ollama ëŒ€ë¹„ 50% ë¹ ë¦„) âš¡
- Balanced (22ê°œ): 15-20ë¶„ (Ollama ëŒ€ë¹„ 50% ë¹ ë¦„) âš¡
- **ì´ ì˜ˆìƒ**: 45-65ë¶„ (1-1.5ì‹œê°„) â­

**íŒë‹¨**: âœ… **ì˜ˆìƒ ì‹œê°„ ë²”ìœ„ ë‚´**, ì‹¤í–‰ ê°€ëŠ¥

---

### Risk 3: Diversity ê°œì„  íš¨ê³¼ ë¯¸ë¯¸ ğŸ“‰
**ì¦ìƒ**: í‰ê·  ê³ ìœ  ë¬¸ì„œ ìˆ˜ < 2.5, ë‹¤ì–‘ì„± ë¹„ìœ¨ < 50%
**í™•ë¥ **: Very Low (5-10%)
**ì˜í–¥**: Day 2 ëª©í‘œ ë¯¸ë‹¬ì„±

**ì™„í™” ë°©ì•ˆ**:
1. âœ… **ì¶”ê°€ íŠœë‹ ê³„íš**: diversity_penalty ê°’ ì¦ê°€ (0.3 â†’ 0.5)
2. âœ… **ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦**: ë¡œì§ ì˜¤ë¥˜ í™•ì¸
3. âœ… **Baseline ë°ì´í„° ì¬í™•ì¸**: Before ë°ì´í„° ì •í™•ì„±

**ê·¼ê±°**: Day 2 ì™„ë£Œ ë³´ê³ ì„œì—ì„œ 88.2% Multi-doc ë¹„ìœ¨ ë‹¬ì„± ë³´ê³ 
- í‰ê·  ê³ ìœ  ë¬¸ì„œ ìˆ˜: 2.51 (ëª©í‘œ 2.5 ë‹¬ì„±)
- ë‹¤ì–‘ì„± ë¹„ìœ¨: 57.08% (ëª©í‘œ 50% ë‹¬ì„±)
- Multi-doc ë¹„ìœ¨: 88.2% (ëª©í‘œ 80% ë‹¬ì„±)

**íŒë‹¨**: âœ… **ì´ë¯¸ ëª©í‘œ ë‹¬ì„± ê°€ëŠ¥ì„± ë†’ìŒ**, ì‹¤í–‰ ê°€ëŠ¥

---

### Risk 4: ë‹µë³€ í’ˆì§ˆ íšŒê·€ ğŸ“Š
**ì¦ìƒ**: ë‹µë³€ ì™„ì „ì„± < 75/100 (ê¸°ì¡´ 77.4ì—ì„œ í•˜ë½)
**í™•ë¥ **: Very Low (5%)
**ì˜í–¥**: Diversity Penalty ì¬ì¡°ì • í•„ìš”

**ì™„í™” ë°©ì•ˆ**:
1. âœ… **ìƒ˜í”Œ ë‹µë³€ ìˆ˜ë™ ê²€í† **: 3-5ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
2. âœ… **Deep Quality Assessment ì¬ì‹¤í–‰**: í•„ìš” ì‹œ
3. âœ… **diversity_penalty ë¹„í™œì„±í™” ì˜µì…˜**: 0.0ìœ¼ë¡œ ì¬í…ŒìŠ¤íŠ¸

**íŒë‹¨**: âœ… **ë¦¬ìŠ¤í¬ ë§¤ìš° ë‚®ìŒ**, ì‹¤í–‰ ê°€ëŠ¥

---

## ğŸ¯ ì‹¤í–‰ ì¤€ë¹„ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì‹œì‘ ì „ âœ…
- [x] Ollama ì„œë²„ ì •ìƒ ì‘ë™ í™•ì¸
- [x] config_test.json diversity_penalty=0.3 í™•ì¸
- [x] 68ê°œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ íŒŒì¼ ì¡´ì¬ í™•ì¸
- [x] analyze_diversity_results.py ìŠ¤í¬ë¦½íŠ¸ í™•ì¸
- [x] ë””ìŠ¤í¬ ê³µê°„ ì¶©ë¶„ (~500MB ì˜ˆìƒ)
- [x] run_comprehensive_test_real.py diversity_penalty ì „ë‹¬ í™•ì¸

### Fallback Plan âœ…
- [x] gpt-4o-mini ì „í™˜ ë°©ë²• ë¬¸ì„œí™”
- [x] ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ (22ê°œ) ì˜µì…˜ ì¤€ë¹„
- [x] ì¬ì‹œë„ ë¡œì§ í™•ì¸

### ë¦¬ìŠ¤í¬ ê´€ë¦¬ âœ…
- [x] 4ê°œ ì£¼ìš” ë¦¬ìŠ¤í¬ ì‹ë³„
- [x] ëª¨ë“  ë¦¬ìŠ¤í¬ì— ëŒ€í•œ ì™„í™” ë°©ì•ˆ ìˆ˜ë¦½
- [x] Fallback Plan ì¤€ë¹„ ì™„ë£Œ

---

## ğŸš€ ì‹¤í–‰ ë‹¨ê³„ ìš”ì•½

### Phase 1: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (1.5-2ì‹œê°„)
```bash
# Step 1: Comprehensive Test (46ê°œ)
python run_comprehensive_test_real.py \
  --test-cases test_cases_comprehensive_v2.json \
  --config config_test.json \
  --output-dir test_logs_diversity_day2_comprehensive \
  --summary test_summary_diversity_day2_comprehensive.json

# Step 2: Balanced Test (22ê°œ)
python run_comprehensive_test_real.py \
  --test-cases test_cases_balanced.json \
  --config config_test.json \
  --output-dir test_logs_diversity_day2_balanced \
  --summary test_summary_diversity_day2_balanced.json
```

### Phase 2: Diversity ë¶„ì„ (30ë¶„)
```bash
# Step 3: Diversity ì§€í‘œ ê³„ì‚°
python analyze_diversity_results.py \
  --test-logs-dir test_logs_diversity_day2_comprehensive \
  --output diversity_analysis_day2_verified.json
```

### Phase 3: ê²°ê³¼ ë¶„ì„ ë° ë³´ê³ ì„œ (30ë¶„)
- Before/After ë¹„êµ
- ëª©í‘œ ë‹¬ì„± ì—¬ë¶€ í‰ê°€
- Day 2 ë³´ê³ ì„œ ì—…ë°ì´íŠ¸

---

## ğŸ“‹ ì˜ˆìƒ ê²°ê³¼

### ì‹œë‚˜ë¦¬ì˜¤ 1: ë³´ìˆ˜ì  ëª©í‘œ ë‹¬ì„± (70% í™•ë¥ ) âœ…
- í‰ê·  ê³ ìœ  ë¬¸ì„œ ìˆ˜: 2.5-3.0 âœ…
- ë‹¤ì–‘ì„± ë¹„ìœ¨: 50-60% âœ…
- Multi-doc ë¹„ìœ¨: 60-80% âœ…
- **íŒë‹¨**: Day 2 ì‘ì—… ì„±ê³µ, ì¶”ê°€ íŠœë‹ ë¶ˆí•„ìš”

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì •ìƒ ëª©í‘œ ë‹¬ì„± (20% í™•ë¥ ) â­
- í‰ê·  ê³ ìœ  ë¬¸ì„œ ìˆ˜: 3.0-3.5 â­
- ë‹¤ì–‘ì„± ë¹„ìœ¨: 60-70% â­
- Multi-doc ë¹„ìœ¨: 80-90% â­
- **íŒë‹¨**: Day 2 ì‘ì—… ëŒ€ì„±ê³µ, ëª©í‘œ ì´ˆê³¼ ë‹¬ì„±

### ì‹œë‚˜ë¦¬ì˜¤ 3: ëª©í‘œ ë¯¸ë‹¬ (10% í™•ë¥ ) âš ï¸
- í‰ê·  ê³ ìœ  ë¬¸ì„œ ìˆ˜: < 2.5
- ë‹¤ì–‘ì„± ë¹„ìœ¨: < 50%
- Multi-doc ë¹„ìœ¨: < 60%
- **íŒë‹¨**: diversity_penalty ê°’ ì¦ê°€ í•„ìš” (0.3 â†’ 0.5)

---

## ğŸ’¡ ì‹¤í–‰ ê¶Œì¥ì‚¬í•­

### 1. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìˆœì„œ
1. âœ… **ë¨¼ì € Balanced Test (22ê°œ) ì‹¤í–‰**
   - ì†Œìš” ì‹œê°„: 30-40ë¶„
   - ë¹ ë¥¸ ê²€ì¦ ê°€ëŠ¥
   - ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¡°ê¸° ë°œê²¬

2. âœ… **Balanced Test ì„±ê³µ ì‹œ Comprehensive Test (46ê°œ) ì‹¤í–‰**
   - ì†Œìš” ì‹œê°„: 60-90ë¶„
   - ì „ì²´ ê²€ì¦ ì™„ë£Œ

### 2. ëª¨ë‹ˆí„°ë§
- âœ… ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸ (`tail -f test_logs_*/test_*.json`)
- âœ… diversity_penalty ì ìš© í™•ì¸ (ë¡œê·¸ì—ì„œ "diversity_penalty" ê²€ìƒ‰)
- âœ… ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨ ë° Fallback Plan ì‹¤í–‰

### 3. ë°ì´í„° ë°±ì—…
- âœ… ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ë¡œê·¸ ë°±ì—… (ìˆëŠ” ê²½ìš°)
- âœ… config_test.json ë°±ì—…

---

## âœ… ìµœì¢… íŒë‹¨: ì‹¤í–‰ ì¤€ë¹„ ì™„ë£Œ

### ì¤€ë¹„ ì™„ë£Œ í•­ëª© (11/11) âœ…
1. âœ… í•„ìˆ˜ íŒŒì¼ í™•ì¸ (100%)
2. âœ… Config ì„¤ì • í™•ì¸ (100%)
3. âœ… í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ í™•ì¸ (100%)
4. âœ… Ollama ì„œë²„ í™•ì¸ (100%)
5. âœ… ë¦¬ìŠ¤í¬ ë¶„ì„ ì™„ë£Œ (4ê°œ ë¦¬ìŠ¤í¬, ëª¨ë‘ ì™„í™” ë°©ì•ˆ ìˆ˜ë¦½)
6. âœ… Fallback Plan ì¤€ë¹„ (100%)
7. âœ… ì˜ˆìƒ ì‹œê°„ ê²€í†  (2-2.5ì‹œê°„, ê³„íš ë²”ìœ„ ë‚´)
8. âœ… ì˜ˆìƒ ê²°ê³¼ ì‹œë‚˜ë¦¬ì˜¤ (3ê°œ ì‹œë‚˜ë¦¬ì˜¤, 70% ì„±ê³µ í™•ë¥ )
9. âœ… ì‹¤í–‰ ê¶Œì¥ì‚¬í•­ ìˆ˜ë¦½
10. âœ… ëª¨ë‹ˆí„°ë§ ê³„íš ìˆ˜ë¦½
11. âœ… ë°ì´í„° ë°±ì—… ê³„íš ìˆ˜ë¦½

### ì„±ê³µ í™•ë¥  í‰ê°€
- **ë³´ìˆ˜ì  ëª©í‘œ ë‹¬ì„±**: 70% (ë†’ìŒ)
- **ì •ìƒ ëª©í‘œ ë‹¬ì„±**: 20% (ë³´í†µ)
- **ëª©í‘œ ë¯¸ë‹¬**: 10% (ë‚®ìŒ)

### ìµœì¢… ê²°ë¡ 
**âœ… Day 2 Diversity Penalty ê²€ì¦ ì‹¤í–‰ ì¤€ë¹„ ì™„ë£Œ**

ëª¨ë“  í•„ìˆ˜ í•­ëª©ì´ í™•ì¸ë˜ì—ˆê³ , ë¦¬ìŠ¤í¬ ì™„í™” ë°©ì•ˆì´ ìˆ˜ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤.
**ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥** ìƒíƒœì…ë‹ˆë‹¤.

---

**ì‘ì„±ì¼**: 2025-11-12
**ê²€ì¦ì**: Claude Code
**ìƒíƒœ**: âœ… ì‹¤í–‰ ì¤€ë¹„ ì™„ë£Œ
**ë‹¤ìŒ ë‹¨ê³„**: Phase 1 í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Balanced Test 22ê°œë¶€í„° ì‹œì‘ ê¶Œì¥)
