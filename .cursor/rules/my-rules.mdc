---
alwaysApply: true
---

# Python 개발 환경 규칙

## 가상환경 사용 필수
- Python 앱(desktop_app.py, app.py 등)을 실행할 때는 **반드시 가상환경을 먼저 활성화**해야 합니다.
- 가상환경 없이 실행하면 모듈 import 오류 및 의존성 문제가 발생합니다.

### 올바른 실행 방법

**Windows (PowerShell):**
```powershell
.\venv\Scripts\activate
python desktop_app.py
```

**또는 한 줄로:**
```powershell
.\venv\Scripts\python.exe desktop_app.py
```

**백그라운드 실행 시에도 동일:**
```powershell
.\venv\Scripts\python.exe desktop_app.py
```

### 잘못된 실행 방법 (오류 발생)
```powershell
# ❌ 가상환경 없이 실행 - ModuleNotFoundError 발생
python desktop_app.py
```

### PyInstaller 빌드 시에도 가상환경 필수
```powershell
.\venv\Scripts\activate
.\venv\Scripts\pyinstaller.exe OC_RAG_Desktop.spec --noconfirm
```

## 구조 인식 청킹 전략 참조

### 필수 참조 문서
- **구조 인식 청킹 전략**: `docs/structure_aware_chunking_strategy.md`
- **PDF 고급 청킹 전략**: `docs/structure_aware_chunking_strategy_PDF.md`
- **PPTX 고급 청킹 전략**: `docs/structure_aware_chunking_strategy_PPT(PPTX).md`
- **파일별 개선 진행플랜**: `docs/file_based_chunking_improvement_plan.md`
- 문서 처리 및 청킹 관련 작업 시 **반드시 이 문서들을 참조**해야 합니다.
- PDF, PPT/PPTX, XLS/XLSX, Text 4가지 타입별 최적화된 청킹 전략이 정의되어 있습니다.
- PDF는 Small-to-Large 아키텍처와 Layout-Aware 분석을 적용합니다.
- PPTX는 슬라이드 단위 Small-to-Large와 paragraph.level 기반 불릿 그룹핑을 적용합니다.
- 구현 시 파일별 단계적 접근 방식을 따릅니다.

### 청킹 전략 적용 원칙
- **문서 타입별 구조 인식**: 각 문서의 고유한 구조를 분석하여 의미론적 청킹 수행
- **가중치 시스템**: 청크 타입별로 다른 가중치 적용 (제목 > 노트 > 일반 문단)
- **메타데이터 풍부화**: 청크의 특성과 컨텍스트 정보를 상세히 기록
- **최적 청크 크기**: 문서 타입별로 다른 최적 크기 사용 (PDF: 500, PPTX: 300, XLSX: 400, TXT: 500)

### 구현 시 주의사항
- 기존 청킹 로직과의 호환성 유지
- 성능 테스트를 통한 최적화
- 사용자 피드백 반영
- 점진적 적용 (1단계 → 2단계 → 3단계)

## LangGraph 업그레이드 관련

### 현재 상태
- **LangGraph 분석 완료**: `LANGGRAPH_ANALYSIS.md`에 상세 비교 분석 저장
- **결정**: 현재 시스템 유지, 나중에 필요 시 적용 검토
- **이유**: 구현 복잡도 대비 효과 미흡, 응답 속도 저하, 대부분 간단한 질문 처리

### LangGraph 적용 검토 기준
- ✅ 복잡한 분석 질문 처리가 핵심 요구사항이 될 때
- ✅ 현재 시스템 개선으로 해결되지 않을 때
- ✅ 응답 속도보다 정확도가 절대 우선일 때
- ✅ 프로덕션 검증 완료 후
- ❌ 현재: 적용 보류 (파라미터 최적화로 충분)

## PySide6 데스크톱 애플리케이션 개발 계획

### 현재 상태
- **구현 완료**: Phase 1-2 완료 (기본 구조 및 핵심 기능)
- **메인 앱**: `desktop_app.py` - PySide6 기반 데스크톱 앱
- **UI 컴포넌트**: 
  - `ui/main_window.py` - 메인 윈도우 (탭 레이아웃, 시스템 트레이)
  - `ui/chat_widget.py` - 채팅 위젯 (스트리밍 응답, 대화 이력)
  - `ui/document_widget.py` - 문서 관리 위젯 (업로드, 목록, 삭제)
  - `ui/settings_widget.py` - 설정 위젯 (LLM, 임베딩, 문서 처리 설정)
- **리소스**: `resources/icons/`, `resources/styles/`

### 프로젝트 구조
```
RAG_for_OC_251014/
├── app.py                    # Streamlit 메인 앱 (기존)
├── desktop_app.py           # PySide6 메인 앱 (구현 완료)
├── config.py                # 설정 관리 (공통)
├── utils/                   # 공통 유틸리티 (백엔드 재사용)
│   ├── rag_chain.py         # RAG 체인
│   ├── vector_store.py      # 벡터 스토어
│   ├── document_processor.py # 문서 처리
│   └── chat_history.py      # 대화 이력 관리
├── ui/                      # PySide6 UI 컴포넌트 (구현 완료)
│   ├── main_window.py       # 메인 윈도우 (탭, 트레이, 자동저장)
│   ├── chat_widget.py       # 채팅 위젯 (스트리밍, 메시지 표시)
│   ├── document_widget.py   # 문서 관리 위젯 (업로드, 목록)
│   └── settings_widget.py   # 설정 위젯 (다중 쿼리 설정 포함)
└── resources/               # 리소스 파일
    ├── icons/               # 아이콘 (app.png)
    └── styles/              # 스타일시트 (향후 확장)
```

### 기술 스택
- **UI 프레임워크**: PySide6 (Qt6) ✅
- **백엔드**: 기존 RAG 시스템 100% 재사용 ✅
- **스타일링**: qdarkstyle (다크 테마 기본) ✅
- **빌드 도구**: PyInstaller (향후 구현)

### 구현된 주요 기능

#### 1. 문서 관리 ✅
- 파일 업로드 (드래그 앤 드롭, 파일 선택 다이얼로그)
- 지원 형식: PDF, PPTX, XLSX, TXT
- 문서 정보: 파일명, 크기, 업로드 시간, 청크 수
- 작업: 삭제, 미리보기, 통계 보기

#### 2. 채팅 인터페이스 ✅
- 메시지 표시: 사용자/AI 메시지 구분 (ChatBubble)
- 스트리밍 응답: 실시간 타이핑 표시
- 출처 표시: 참조 문서 및 유사도 점수
- 입력 기능: 멀티라인 텍스트 입력
- 이력 관리: 대화 저장/로드/초기화/내보내기

#### 3. 설정 관리 ✅
- LLM 설정: API 타입, 모델, 키, URL, temperature
- 임베딩 설정: 모델, API 타입, 키
- 문서 설정: 청크 크기, 오버랩 (UI에서 숨김 처리)
- 다중 쿼리 설정: 갯수 선택 (0-5)
- Reranker 설정: 사용 여부, 모델 선택

#### 4. 시스템 기능 ✅
- 시스템 트레이: 백그라운드 실행 지원
- 자동 저장: 설정 및 대화 이력 자동 저장
- 세션 관리: 대화 목록, 새 세션 시작, 불러오기
- 에러 처리: 초기화 실패 시 알람 다이얼로그

### 향후 확장 계획

#### Phase 3: UI/UX 개선 (진행 중)
- [ ] 커스텀 스타일시트 (QSS) 적용
- [ ] 라이트 테마 지원
- [ ] 키보드 단축키 (Ctrl+N: 새 대화, Ctrl+S: 저장 등)
- [ ] 컨텍스트 메뉴 (우클릭 메뉴)

#### Phase 4: 고급 기능
- [ ] 파일 연결 (특정 확장자 파일 더블클릭 실행)
- [ ] 자동 업데이트 체크
- [ ] 성능 모니터링 (메모리, CPU 사용량 표시)
- [ ] 로그 뷰어 (디버깅용)

#### Phase 5: 빌드 및 배포
- [ ] PyInstaller spec 파일 작성
- [ ] 아이콘/리소스 포함 설정
- [ ] 단일 실행 파일 생성
- [ ] 설치 패키지 생성 (NSIS/Inno Setup)

### 개발 원칙
- **코드 재사용**: 백엔드 100% 재사용 (utils/ 폴더)
- **설정 호환성**: Streamlit과 동일한 config.json 사용
- **데이터 호환성**: 동일한 ChromaDB 및 대화 이력 형식 유지
- **점진적 개발**: Phase별 단계적 구현 및 확장
- **에러 처리**: 사용자 친화적인 에러 메시지 및 알람

### 성능 목표
- **시작 시간**: 3초 이내 ✅ (현재 달성)
- **메모리 사용량**: 500MB 이내 (모니터링 필요)
- **응답 시간**: 질문당 5초 이내 (백엔드 의존)
- **UI 반응성**: 100ms 이내 ✅ (현재 달성)

## OC Papers 프로젝트 정의서

### 프로젝트 핵심 목적
**OC Papers**는 사내망 환경에서 논문 데이터베이스를 구축하고, 엔지니어들에게 정확하고 신뢰할 수 있는 정보를 제공하는 AI 챗봇 시스템입니다. 향후 논문뿐만 아니라 다양한 개발결과물(엑셀, 파워포인트, PDF, raw data 등)을 활용하여 **엔지니어를 보조하는 자율 에이전트 AI**로 발전시킬 계획입니다.

### 주요 사용 시나리오

#### 시나리오 1: 특정 논문에 대한 질문
**목적**: 특정 논문의 내용을 빠르게 이해하고 요약
**예시**: "[논문명]의 주요 내용을 요약해줘", "[논문명]에서 제시한 핵심 방법론은?"
**성공 기준**: 논문의 핵심 내용을 정확히 반영, 주요 섹션 포함, Citation이 해당 논문을 정확히 가리킴

#### 시나리오 2: 주제/키워드 기반 논문 검색
**목적**: 특정 주제나 키워드로 관련 논문을 찾고 요약
**예시**: "OLED 효율 향상에 대한 논문을 찾아줘", "모든 OLED 논문을 찾아줘" (Exhaustive Query)
**성공 기준**: 관련 논문을 정확히 찾음, 여러 논문을 제시 (다양성), 각 논문의 관련성을 설명

#### 시나리오 3: 여러 논문에서 인사이트 추출
**목적**: 여러 논문의 정보를 종합하여 인사이트를 얻음
**예시**: "OLED와 QLED 기술의 차이점을 비교해줘", "OLED 효율 향상 기술의 발전 추세는?"
**성공 기준**: 여러 논문에서 정보를 종합, 각 논문의 특징을 정확히 비교, Citation이 여러 논문을 가리킴, 단순 나열이 아닌 통합적 분석

### 핵심 기능

#### 1. 문서 처리
- **PDF**: 구조 인식 청킹 (Small-to-Large), Layout-Aware 분석
- **PPTX**: 슬라이드 단위 청킹, Vision 기반 표/그래프 인식
- **XLSX**: 셀 단위 추출 및 구조 보존
- **TXT**: 기본 텍스트 분할

#### 2. 검색 및 검색
- **Hybrid Search**: BM25 (키워드) + Vector (의미) 통합 검색
- **Multi-Query Expansion**: 질문을 여러 쿼리로 확장하여 리콜 향상
- **Re-ranker**: Cross-encoder 기반 정확도 향상
- **Diversity Penalty**: 동일 논문 중복 방지, 다양한 논문 선택

#### 3. 답변 생성
- **Question Classifier**: 질문 유형 자동 분류 (simple/normal/complex/exhaustive)
- **Small-to-Large**: 작은 청크 + 큰 컨텍스트로 정확도 향상
- **Citation Generation**: NotebookLM 스타일 인라인 인용 (95% 목표)
- **Answer Verification**: 답변 품질 검증 및 재생성

#### 4. 파일 레벨 집계
- **Exhaustive Query 감지**: "모든/전체" 키워드 자동 감지
- **파일 리스트 반환**: 관련 논문을 파일 단위로 집계하여 리스트 제공
- **가중치 기반 점수**: WEIGHTED 전략으로 관련도 계산

### 성능 목표 (품질 중심)

#### 품질 지표
- **답변 정확도**: 90% 이상
- **답변 완전성**: 85% 이상
- **출처 다양성**: 평균 2.5개 이상 (다중 논문 질문)
- **Citation Coverage**: 95% 이상
- **인사이트 추출**: 80% 이상 (다중 논문 질문)

#### 성능 지표
- **응답 시간**: 질문당 5초 이내 (백엔드 의존)
- **시작 시간**: 3초 이내
- **메모리 사용량**: 500MB 이내

### 개발 원칙
- **코드 재사용**: 백엔드 100% 재사용 (utils/ 폴더)
- **설정 중심**: config.json으로 모든 동작 제어
- **오프라인 우선**: 외부 네트워크 의존성 최소화
- **점진적 개발**: Phase별 단계적 구현 및 확장
- **데이터 기반 의사결정**: 모든 개선 조치에 정량 지표 설정

### 프로젝트 상태 (v3.7.0)
- ✅ Phase 1-2: 기본 구조 및 핵심 기능 완료
- ✅ Phase 3: 검색 품질 및 응답 전략 개선 (진행 중)
- ✅ File Aggregation: Exhaustive Query 파일 리스트 반환
- ✅ Diversity Penalty: 다문서 합성 개선
- ✅ Citation System: NotebookLM 스타일 인라인 인용

### 참고 문서
- **프로젝트 정의서**: `PROJECT_DEFINITION.md`
- **상태 점검 보고서**: `PROJECT_STATUS_CHECK.md`
- **품질 테스트 계획**: `RAG_QUALITY_TEST_PLAN.md`
- **프로젝트 개요**: `.CLAUDE.md`