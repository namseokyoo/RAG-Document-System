# RAG 시스템 성능 진단 보고서

**작성일:** 2025-11-08
**진단 도구:** quick_performance_check.py
**테스트 질문 수:** 3개

---

## 요약

RAG 시스템의 각 단계를 분석한 결과, **카테고리 필터링 실패**와 **비효율적인 검색 전략**이 주요 성능 저하 원인으로 확인되었습니다.

---

## 1. 정상 작동하는 컴포넌트

### ✅ Question Classifier (정상)
- **상태:** 정상 작동
- **분류 정확도:** 높음
- **테스트 결과:**
  - "OLED는 무엇인가?" → `normal` (80% 신뢰도, rule 방식)
  - "TADF의 효율은?" → `simple` (100% 신뢰도, rule 방식)
  - "kFRET 값은?" → `simple` (100% 신뢰도, rule 방식)

### ✅ 유사도 검색 (정상)
- **상태:** 정상 작동
- **검색 품질:** 양호
- **테스트 결과:**
  - "OLED는 무엇인가?" → 유사도 점수 74.9 (관련 문서 정확히 검색)
  - "TADF의 효율은?" → 유사도 점수 166.7
  - "kFRET 값은?" → 유사도 점수 123.4

---

## 2. 발견된 문제점

### ❌ 문제 1: 카테고리 필터링 실패 (심각)

**증상:**
```
[WARN] 카테고리 필터를 찾을 수 없음 (0건), 필터를 비활성화
```

**영향:**
- 모든 테스트 질문에서 카테고리 필터가 0건의 문서를 반환
- 질문 카테고리는 정확히 감지됨 (technical, business)
- 하지만 해당 카테고리의 문서를 찾지 못함

**원인 분석:**
1. 문서 메타데이터에 카테고리 정보가 누락되었거나
2. 카테고리 검색 로직의 필터 조건이 잘못 설정되었거나
3. 카테고리 이름 매칭이 실패 (대소문자, 오타 등)

**성능 영향:**
- **검색 정확도 저하**: 관련 없는 카테고리 문서도 검색됨
- **응답 시간 증가**: 불필요한 문서 처리
- **답변 품질 저하**: 노이즈 증가

---

### ❌ 문제 2: Small-to-Large 검색의 과도한 사용

**증상:**
```
[Timing] context retrieval (Small-to-Large, type=specific_info): 14.22s
```

**영향:**
- Simple 질문에도 Small-to-Large 검색이 사용됨
- 검색 시간이 매우 김 (14초+)
- "OLED는 무엇인가?" (normal) → Small-to-Large 사용
- "TADF의 효율은?" (simple) → Small-to-Large 사용
- "kFRET 값은?" (simple) → Small-to-Large 사용

**원인 분석:**
- 카테고리 필터가 실패하면 Small-to-Large가 fallback으로 사용됨
- Simple 질문에는 Standard 검색이 더 적합함
- Question Classifier의 분류 결과가 검색 전략에 제대로 반영되지 않음

**성능 영향:**
- **응답 시간 급증**: 14초+ (목표: 3초 이하)
- **불필요한 연산**: Simple 질문에 복잡한 검색 불필요
- **사용자 경험 저하**: 느린 응답 속도

---

### ❌ 문제 3: 유니코드 인코딩 오류 (부차적)

**증상:**
```
[LLM][WARN] 처리 오류: 'cp949' codec can't encode character '\U0001f4c4'
```

**영향:**
- LLM 답변 생성 단계에서 에러 발생
- 이모지 문자 (📄) 출력 시 cp949 인코딩 실패

**원인:**
- Windows 콘솔의 기본 인코딩이 cp949 (한국어)
- 로그 메시지에 이모지 포함
- UTF-8 환경 설정 필요

**성능 영향:**
- 답변 생성 실패
- 에러 메시지 출력 불가

---

## 3. 검색 프로세스 분석

### "OLED는 무엇인가?" 질문의 처리 흐름

1. **질문 분류** (✅ 정상)
   - 유형: normal
   - 신뢰도: 80%
   - Max Results: 20

2. **카테고리 감지** (✅ 정상)
   - 감지된 카테고리: technical, business
   - LLM 응답 시간: 19ms (빠름)

3. **카테고리 필터링** (❌ 실패)
   - 필터 결과: **0건**
   - 폴백: Small-to-Large 검색으로 전환

4. **Small-to-Large 검색** (⚠️ 비효율)
   - 검색 시간: 14.46초
   - 임베딩 호출: 6회 (총 310개 텍스트)
   - 너무 느림!

5. **LLM 답변 생성** (❌ 실패)
   - 입력 토큰: 2161개
   - 유니코드 에러로 실패

---

### "TADF의 효율은?" 질문의 처리 흐름

1. **질문 분류** (✅ 정상)
   - 유형: simple (정확!)
   - 신뢰도: 100%
   - Max Results: 10

2. **LLM Top-K 판단** (✅ 정상)
   - 판단 결과: top_k = 5
   - LLM 응답: 1ms (매우 빠름)

3. **Standard 검색 시도** (✅ 정상)
   - Hybrid 검색 (BM25 + Vector)
   - 후보 검색: 5.09초 (30개)
   - Re-ranking: 2.23초
   - **총 8.49초** (적절)

4. **카테고리 필터링** (❌ 실패)
   - 다시 카테고리 감지 시도
   - 필터 결과: **0건**
   - 폴백: Small-to-Large로 전환

5. **Small-to-Large 검색** (⚠️ 중복)
   - 검색 시간: 14.04초 (추가)
   - **총 시간: 8.49s + 19.38s = 27.87초!**

6. **LLM 답변 생성** (❌ 실패)
   - 입력 토큰: 4822개
   - 유니코드 에러로 실패

---

## 4. 성능 저하 원인 요약

| 문제 | 심각도 | 영향 | 발생 빈도 |
|------|--------|------|-----------|
| 카테고리 필터링 실패 | 🔴 심각 | 검색 정확도/속도 저하 | 100% (모든 질문) |
| Small-to-Large 과다 사용 | 🔴 심각 | 응답 시간 14초+ | 100% (모든 질문) |
| 유니코드 인코딩 오류 | 🟡 중간 | 답변 생성 실패 | 100% (로그 출력) |
| 중복 검색 실행 | 🔴 심각 | 응답 시간 2배 증가 | 특정 질문 |

---

## 5. 근본 원인 분석

### 🎯 핵심 문제: 카테고리 메타데이터 불일치

**가설:**
1. 문서 임베딩 시 카테고리 메타데이터가 저장되지 않음
2. 카테고리 필터 쿼리가 잘못된 필드명 사용
3. 카테고리 값의 형식이 일치하지 않음 (예: "technical" vs "Technical")

**검증 필요:**
```python
# ChromaDB 메타데이터 확인
vectorstore.vectorstore.get()['metadatas'][:5]

# 카테고리 필드 존재 확인
```

---

### 🎯 부차 문제: 검색 전략 선택 로직 결함

**현재 동작:**
```
카테고리 필터 시도 → 실패 (0건) → Small-to-Large로 fallback
```

**기대 동작:**
```
Simple 질문 → Standard 검색 (빠름)
Normal 질문 → Hybrid 검색 (중간)
Complex 질문 → Small-to-Large (느림)
```

**문제:**
- Question Classifier의 분류 결과가 검색 전략에 반영되지 않음
- 카테고리 필터 실패 시 무조건 Small-to-Large 사용
- 질문 복잡도를 고려하지 않음

---

## 6. 권장 조치사항

### 🔧 즉시 조치 (High Priority)

1. **카테고리 메타데이터 확인 및 수정**
   - ChromaDB에서 실제 메타데이터 구조 확인
   - 문서 재임베딩 또는 메타데이터 업데이트
   - 카테고리 필터 쿼리 수정

2. **Small-to-Large 사용 조건 개선**
   ```python
   # 현재
   if category_docs == 0:
       use_small_to_large()

   # 개선안
   if question_type == "simple":
       use_standard_search()
   elif question_type == "normal":
       use_hybrid_search()
   elif category_docs == 0 and question_type == "complex":
       use_small_to_large()
   ```

3. **유니코드 인코딩 수정**
   - 로그 메시지에서 이모지 제거
   - 또는 UTF-8 인코딩 강제 설정
   ```python
   import sys
   sys.stdout.reconfigure(encoding='utf-8')
   ```

### 🔨 중기 조치 (Medium Priority)

4. **검색 전략 최적화**
   - Question Classifier 결과를 검색 전략 선택에 직접 반영
   - Simple 질문: Standard 검색만 사용
   - Normal 질문: Hybrid 검색 우선
   - Complex 질문: Small-to-Large 고려

5. **성능 모니터링 강화**
   - 각 단계별 소요 시간 로깅
   - 검색 전략별 성공률 추적
   - 카테고리 필터 성공률 모니터링

### 📊 장기 조치 (Low Priority)

6. **문서 카테고리 자동 분류**
   - 기존 문서에 카테고리 자동 할당
   - LLM 기반 카테고리 분류기 구축

7. **캐싱 메커니즘 도입**
   - 자주 검색되는 질문 결과 캐싱
   - 임베딩 결과 캐싱

---

## 7. 예상 성능 개선 효과

| 조치 | 현재 | 목표 | 개선율 |
|------|------|------|--------|
| 카테고리 필터링 수정 | 0% 성공 | 80% 성공 | +80% |
| 검색 전략 최적화 | 14초+ | 3초 이하 | -78% |
| Small-to-Large 조건 개선 | 100% 사용 | 20% 사용 | -80% |
| **전체 응답 시간** | **27초** | **5초** | **-81%** |

---

## 8. 결론

현재 RAG 시스템의 주요 문제는:
1. **카테고리 필터링이 전혀 작동하지 않음** (0% 성공률)
2. **모든 질문에 가장 느린 Small-to-Large 검색 사용** (불필요)
3. **Question Classifier의 분류 결과가 활용되지 않음** (낭비)

이 문제들을 해결하면 **응답 시간 81% 단축**과 **답변 품질 향상**을 기대할 수 있습니다.

특히 Simple 질문 ("TADF의 효율은?")의 경우, Standard 검색만 사용하면 **27초 → 3초**로 단축 가능합니다.

---

## 9. 다음 단계

1. ✅ 진단 완료 (현재 단계)
2. ⏭️ 카테고리 메타데이터 검증 (`check_chromadb_metadata.py` 실행)
3. ⏭️ 카테고리 필터링 수정
4. ⏭️ 검색 전략 로직 개선
5. ⏭️ 성능 재측정 및 검증

---

**진단 완료**
